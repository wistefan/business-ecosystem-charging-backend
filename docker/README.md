# Business Ecosystem Charging Backend Docker Image

Starting on version 5.4.0, you are able to run the Business API Ecosystem with Docker. In this context, the current repository contains the Docker image of the Business Ecosystem Charging Backend component, so you can run it stand alone.

You can build a docker image based on this Dockerfile. This image will contain only an instance of the Business Ecosystem Charging Backend, exposing port `8006`. This requires that you have [docker](https://docs.docker.com/installation/) installed on your machine.

If you just want to have a Business Ecosystem Charging Backend instance running as quickly as possible jump to section *The Fastest Way*.

If you want to know what is behind the scenes of our container you can go ahead and read the build and run sections.

## The Fastest Way

Versions of the Business Ecosystem Charging Backend container higher than 5.4.1 use an external MongoDB container as database and are
configured in the same way as the software, using both, the standard `settings.py` file or the supported environment variables (min version 7.4.0). For details of the different configuration
options, have a look at the [Business API Ecosystem Installation Guide](https://business-api-ecosystem.readthedocs.io/en/develop/installation-administration-guide.html#configuring-the-charging-backend)

To run the Business Ecosystem Charging Backend, `docker-compose` is used. To do so, you can use the file `docker-compose.yml` provided with the source code or create a new one with the following content:

```
version: '3'
services:
    mongo:
        image: mongo:3.2
        ports:
            - 27017:27017
        volumes:
            - ./charging-data:/data/db

    charging:
        image: conwetlab/biz-ecosystem-charging-backend:develop
        links:
            - mongo
        depends_on:
            - mongo
        ports:
            - 8006:8006
        volumes:
            # - ./charging-settings:/business-ecosystem-charging-backend/src/user_settings  # Used if the settings files are provided through the volume 
            - ./charging-bills:/business-ecosystem-charging-backend/src/media/bills
            - ./charging-assets:/business-ecosystem-charging-backend/src/media/assets
            - ./charging-plugins:/business-ecosystem-charging-backend/src/plugins
            - ./charging-inst-plugins:/business-ecosystem-charging-backend/src/wstore/asset_manager/resource_plugins/plugins
        environment:
          - BAE_CB_PAYMENT_METHOD=None  # Paypal or None (testing mode payment disconected)
          # - BAE_CB_PAYPAL_CLIENT_ID=client_id
          # - BAE_CB_PAYPAL_CLIENT_SECRET=client_secret

          # ----- Database configuration ------
          - BAE_CB_MONGO_SERVER=mongo
          - BAE_CB_MONGO_PORT=27017
          - BAE_CB_MONGO_DB=charging_db
          # - BAE_CB_MONGO_USER=user
          # - BAE_CB_MONGO_PASS=passwd

          # ----- Roles Configuration -----
          - BAE_LP_OAUTH2_ADMIN_ROLE=admin
          - BAE_LP_OAUTH2_SELLER_ROLE=seller
          - BAE_LP_OAUTH2_CUSTOMER_ROLE=customer

          # ----- Email configuration ------
          - BAE_CB_EMAIL=charging@email.com
          # - BAE_CB_EMAIL_USER=user
          # - BAE_CB_EMAIL_PASS=pass
          # - BAE_CB_EMAIL_SMTP_SERVER=smtp.server.com
          # - BAE_CB_EMAIL_SMTP_PORT=587

          - BAE_CB_VERIFY_REQUESTS=True  # Whether or not the BAE validates SSL certificates on requests to external components 

          # ----- Site configuration -----
          - BAE_SERVICE_HOST=https://store.lab.fiware.org/  # External URL used to access the BAE
          - BAE_CB_LOCAL_SITE=http://charging.docker:8006/  # Local URL of the charging backend

          # ----- APIs Conection config -----
          - BAE_CB_CATALOG=http://apis.docker:8080/DSProductCatalog
          - BAE_CB_INVENTORY=http://apis.docker:8080/DSProductInventory
          - BAE_CB_ORDERING=http://apis.docker:8080/DSProductOrdering
          - BAE_CB_BILLING=http://apis.docker:8080/DSBillingManagement
          - BAE_CB_RSS=http://rss.docker:8080/DSRevenueSharing
          - BAE_CB_USAGE=http://apis.docker:8080/DSUsageManagement
          - BAE_CB_AUTHORIZE_SERVICE=http://proxy.docker:8004/authorizeService/apiKeys
```

As you can see, the biz-ecosystem-charging-backend image defines 4 volumes. In particular:
* */business-ecosystem-charging-backend/src/user_settings*: This directory must include the *settings.py* and *services_settings.py* files with the software configuration, when the volume configuration is used.
* */business-ecosystem-charging-backend/src/media/bills*: This directory contains the PDF invoices generated by the Business Ecosystem Charging Backend
* */business-ecosystem-charging-backend/src/media/assets*: This directory contains the different digital assets uploaded by sellers to the Business Ecosystem Charging Backend
* */business-ecosystem-charging-backend/src/plugins*: This directory is used for providing asset plugins (see section *Installing Asset Plugins*)
* */business-ecosystem-charging-backend/src/wstore/asset_manager/resource_plugins/plugins*: This directory includes the code of the plugins already installed

It can be seen, that the system can be configured with the environment variables defined by the software (min version 7.4.0). In this case, providing the settings file is
not mandatory, taking into account that the environment variables values override the file ones.

Once you have created the file, run the following command:

```
docker-compose up
```

Then, the Business Ecosystem Charging Backend should be up and running in `http://YOUR_HOST:PORT/` replacing `YOUR_HOST` by the host of your machine and `PORT` by the port selected in the previous step.

Once the different containers are running, you can stop them using:

```
docker-compose stop
```

And start them again using:

```
docker-compose start
```

Additionally, you can terminate the different containers by executing:

```
docker-compose down
```

### Version 5.4.1

Docker image for version 5.4.1 integrates MongoDB as part of the image, reading Charging Backend configuration from the environment

To run Business Ecosystem Charging Backend v5.4.1 using Docker, just run the following command:

```
$ sudo docker run \
    -e PAYPAL_CLIENT_ID=your-client-id \
    -e PAYPAL_CLIENT_SECRET=your-client-secret \
    -e BIZ_ECOSYS_PORT=ext-port \
    -e BIZ_ECOSYS_HOST=ext-host \
    -e GLASSFISH_HOST=glassfish-host \
    -e GLASSFISH_PORT=glassfish-port \
    -e ADMIN_EMAIL=your-email \
    -e EMAIL_USER=your-email-user \
    -e EMAIL_PASSWD=your-email-passwd \
    -e EMAIL_SERVER=your-email-server \
    -e EMAIL_SERVER_PORT=your-email-server-port
    -p your-port:8006 conwetlab/biz-ecosystem-charging-backend:v5.4.1
```

Note in the previous command that it is needed to provide some environment variables. Concretely:

* **PAYPAL_CLIENT_ID**: the client id of your application PayPal credentials used for charging users (a Sandbox account can be used for testing).
* **PAYPAL_CLIENT_SECRET**: the client secret of your application PayPal credentials used for charging users (a Sandbox account can be used for testing).
* **BIZ_ECOSYS_PORT**: Port where the Business Ecosystem Logic proxy is running
* **BIZ_ECOSYS_HOST**: Host where the Business Ecosystem Logic proxy is running
* **GLASSFISH_HOST**: Host where the Glassfish instance with the TMForum APIs is running
* **GLASSFISH_PORT**: Port where the Glassfish instance with the TMForum APIs is running
* **ADMIN_EMAIL**: A valid email used for connecting with the Business Ecosystem RSS
* **EMAIL_USER** (Optional): Username of the email account provided as ADMIN_EMAIL. This setting is used for sending email notifications
* **EMAIL_PASSWD** (Optional): Password of the email account provided as ADMIN_EMAIL. This setting is used for sending email notifications
* **EMAIL_SERVER** (Optional): Host of the email server related to ADMIN_EMAIL. This setting is used for sending email notifications
* **EMAIL_SERVER_PORT** (Optional): Port of the email server related to ADMIN_EMAIL. This setting is used for sending email notifications

Additionally, the biz-ecosystem-charging-backend image contains 4 volumes. In particular:
* */data/db*: This directory contains the data stored in MongoDB by the Business Ecosystem Charging Backend
* */business-ecosystem-charging-backend/src/media/bills*: This directory contains the PDF invoices generated by the Business Ecosystem Charging Backend
* */business-ecosystem-charging-backend/src/media/assets*: This directory contains the different digital assets uploaded by sellers to the Business Ecosystem Charging Backend
* */business-ecosystem-charging-backend/src/plugins*: This directory is used for providing asset plugins (see section *Installing Asset Plugins*)

If you want to locate the host directories where the volumes are being mounted, execute the following command:

```
$ docker inspect your-container
```

Alternatively, you can specify the host directory for the container volumes using the -v flag as follows:
```
$ sudo docker run \
    ...
    -v /home/user/assets:/business-ecosystem-charging-backend/src/media/assets
    -v /home/user/bills:/business-ecosystem-charging-backend/src/media/bills
    -v /home/user/plugins:/business-ecosystem-charging-backend/src/plugins
    ...
    -p your-port:8006 conwetlab/biz-ecosystem-charging-backend
```

## Build the image

If you have downloaded the [Business Ecosystem Charging Backend's source code](https://github.com/FIWARE-TMForum/business-ecosystem-charging-backend) you can build your own image. The end result will be the same, but this way you have a bit more of control of what's happening.

To create the image, just navigate to the `docker` directory and run:

    $ sudo docker build -t biz-ecosystem-charging-backend .

> **Note**
> If you do not want to have to use `sudo` in this or in the next section follow [these instructions](http://askubuntu.com/questions/477551/how-can-i-use-docker-without-sudo).


The parameter `-t biz-ecosystem-charging-backend` gives the image a name. This name could be anything, or even include an organization like `-t conwetlab/biz-ecosystem-charging-backend`. This name is later used to run the container based on the image.

If you want to know more about images and the building process you can find it in [Docker's documentation](https://docs.docker.com/userguide/dockerimages/).
    
## Installing Asset Plugins

As you may know, the Business API Ecosystem is able to sell different types of digital assets
by loading asset plugins in its Charging Backend. In this context, it is possible to install
asset plugins in the current Docker image as follows:

1) Copy the plugin file into the host directory of the volume */business-ecosystem-charging-backend/src/plugins*

2) Enter the running container:
```
docker exec -i -t your-container /bin/bash
```

3) Go to the installation directory
```
cd /business-ecosystem-charging-backend/src
```

4) Load the plugin
```
./manage.py loadplugin ./plugins/pluginfile.zip
```

5) Restart Apache
```
service apache2 restart
```
